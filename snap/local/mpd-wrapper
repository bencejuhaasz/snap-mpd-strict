#!/bin/sh
set -eu

# --- User-writable snap paths ONLY ---
CONF="$SNAP_USER_DATA/mpd.conf"
STATE="$SNAP_USER_DATA"
COMMON="$SNAP_USER_COMMON"
MUSIC="$COMMON/music"

LOG="$STATE/mpd.log"
DB="$STATE/database"
PID="$STATE/pid"
STATEFILE="$STATE/state"
STICKER="$STATE/sticker.sql"
PLAYLISTS="$STATE/playlists"
SOCKET="$STATE/socket"

# --- Ensure directories ---
mkdir -p \
  "$STATE" \
  "$PLAYLISTS" \
  "$COMMON" \
  "$MUSIC"

# --- Ensure log file ---
touch "$LOG"

# --- Generate config once ---
if [ ! -f "$CONF" ]; then
  cat > "$CONF" <<EOF
music_directory     "$MUSIC"
playlist_directory  "$PLAYLISTS"
db_file             "$DB"
log_file            "$LOG"
pid_file            "$PID"
state_file          "$STATEFILE"
sticker_file        "$STICKER"

bind_to_address     "$SOCKET"

audio_output {
    type "pipewire"
    name "PipeWire"
}
EOF
fi

exec "$SNAP/usr/bin/mpd" --no-daemon "$CONF"

